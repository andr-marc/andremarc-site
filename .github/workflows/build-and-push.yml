name: Build, Push and Update Manifests

on:
  push:
    branches: [ main ]


jobs:
  build:
    runs-on: ubuntu-latest


    steps:
      - name: Checkout
        uses: actions/checkout@v4


      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'


      - name: Install dependencies
        run: npm ci --legacy-peer-deps


      - name: Build Angular
        run: npm run build --prod


      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_TOKEN }}


      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ github.sha }}


      - name: (Opcional) Update manifests repo with new image tag
        if: env.MANIFESTS_REPO_URL
        env:
          MANIFESTS_REPO_URL: ${{ secrets.MANIFESTS_REPO_URL }}
          MANIFESTS_BRANCH: ${ { secrets.MANIFESTS_BRANCH || 'main' } }
          GIT_USER: ${{ github.actor }}
          COMMIT_EMAIL: actions@github.com
          IMAGE_REF: ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ github.sha }}
        run: |
          # Clona o repo de manifests (pode ser o mesmo repo ou outro)
          git clone "${MANIFESTS_REPO_URL}" manifests-repo
          cd manifests-repo
          # Substitui o valor da imagem no arquivo deployment.yaml (assuma que deployment.yaml cont√©m placeholder IMAGE_PLACEHOLDER)
          sed -i "s|IMAGE_PLACEHOLDER|${IMAGE_REF}|g" deployment.yaml
          git config user.email "${COMMIT_EMAIL}"
          git config user.name "${GIT_USER}"
          git add deployment.yaml
          git commit -m "ci: update image to ${GITHUB_SHA}" || echo "no changes"
          git push origin ${MANIFESTS_BRANCH}
